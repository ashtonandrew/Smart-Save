<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartSave – Milk Deals</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:24px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    input,select{padding:8px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ddd;padding:8px;font-size:14px}
    th{cursor:pointer}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:2px 8px;margin-right:6px}
  </style>
</head>
<body>
  <h1>SmartSave – Milk Deals</h1>
  <div class="controls">
    <input id="q" placeholder="search title/brand…"/>
    <input id="maxppu" type="number" step="0.01" placeholder="max $/L"/>
    <select id="brand"><option value="">All brands</option></select>
    <button id="reset">Reset</button>
  </div>
  <div id="summary"></div>
  <table id="tbl"><thead></thead><tbody></tbody></table>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const state = { rows: [], sortKey: 'price_per_unit', sortDir: 'asc' };

    // change this if you renamed your file
    const CSV_URL = './data/walmart_milk_clean.csv';

    const $ = (id)=>document.getElementById(id);
    const thead = document.querySelector('#tbl thead');
    const tbody = document.querySelector('#tbl tbody');
    const q = $('q'), brandSel = $('brand'), maxppu = $('maxppu'), summary=$('summary');

    function parseNum(v){ const x = parseFloat(String(v).replace(/[^\d.]/g,'')); return isNaN(x) ? null : x; }

    function inferPricePerUnit(row){
      // if price_per_unit missing, try to infer from title size like “1L”, “946 mL”, “4L”, “6 x 200 mL”
      if(row.price_per_unit) return parseNum(row.price_per_unit);
      const price = parseNum(row.price);
      if(price==null) return null;

      const t = (row.title||'') + ' ' + (row.brand||'');
      const multi = t.match(/(\d+)\s*[xX]\s*(\d+)\s*(mL|ml|ML)/);
      const singleML = t.match(/(\d+(?:\.\d+)?)\s*(mL|ml|ML)/);
      const singleL  = t.match(/(\d+(?:\.\d+)?)\s*(L|l)\b/);

      let mL = null;
      if(multi){ mL = parseFloat(multi[1]) * parseFloat(multi[2]); }
      else if(singleML){ mL = parseFloat(singleML[1]); }
      else if(singleL){ mL = parseFloat(singleL[1]) * 1000; }

      if(!mL) return null;
      const perL = price / (mL/1000);
      return Math.round(perL * 100) / 100; // 2 decimals
    }

    function render(){
      // filters
      const term = q.value.trim().toLowerCase();
      const brand = brandSel.value;
      const max = parseNum(maxppu.value);

      let rows = state.rows.map(r => ({
        ...r,
        price_num: parseNum(r.price),
        ppu: parseNum(r.price_per_unit) ?? inferPricePerUnit(r)
      }));

      rows = rows.filter(r => {
        if(term && !(`${r.title||''} ${r.brand||''}`.toLowerCase().includes(term))) return false;
        if(brand && r.brand !== brand) return false;
        if(max!=null && r.ppu!=null && r.ppu > max) return false;
        return true;
      });

      rows.sort((a,b)=>{
        const k = state.sortKey;
        const av = (k==='price_per_unit') ? (a.ppu ?? Infinity) : (a[k] ?? '');
        const bv = (k==='price_per_unit') ? (b.ppu ?? Infinity) : (b[k] ?? '');
        if(av<bv) return state.sortDir==='asc'? -1: 1;
        if(av>bv) return state.sortDir==='asc'? 1: -1;
        return 0;
      });

      summary.innerHTML = `<div class="pill">items: ${rows.length}</div>` +
        `<div class="pill">best $/L: ${formatPPU(rows)}</div>`;

      // header
      const cols = ['title','brand','price','price_per_unit','url'];
      thead.innerHTML = '<tr>' + cols.map(c=>`<th data-k="${c}">${c}</th>`).join('') + '</tr>';
      [...thead.querySelectorAll('th')].forEach(th=>{
        th.onclick = ()=>{
          const k = th.dataset.k;
          state.sortKey = k;
          state.sortDir = (state.sortKey===k && state.sortDir==='asc')? 'desc':'asc';
          render();
        }
      });

      // body
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${esc(r.title)}</td>
          <td>${esc(r.brand||'')}</td>
          <td>${r.price ?? ''}</td>
          <td>${r.ppu!=null ? `$${r.ppu}/L` : ''}</td>
          <td>${r.url ? `<a href="${r.url}" target="_blank">View</a>` : ''}</td>
        </tr>
      `).join('');
    }

    function esc(s){ return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function formatPPU(rows){
      const vals = rows.map(r=>r.ppu).filter(v=>v!=null);
      if(!vals.length) return '—';
      return `$${Math.min(...vals).toFixed(2)}/L`;
    }

    function initBrands(){
      const brands = [...new Set(state.rows.map(r=>r.brand).filter(Boolean))].sort();
      brandSel.innerHTML = `<option value="">All brands</option>` + brands.map(b=>`<option>${esc(b)}</option>`).join('');
    }

    $('reset').onclick = ()=>{ q.value=''; maxppu.value=''; brandSel.value=''; render(); };

    Papa.parse(CSV_URL, {
      download: true, header: true, skipEmptyLines: true,
      complete: res => { state.rows = res.data; initBrands(); render(); }
    });
  </script>
</body>
</html>
